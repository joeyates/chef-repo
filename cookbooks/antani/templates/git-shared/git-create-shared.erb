#!/usr/bin/env ruby

require 'optparse'
require 'fileutils'

options = { :repositories_path => '<%= node[ :git ][ :home ] %>/repositories' }
opts = OptionParser.new do |opts|

  opts.on( '--project=[PATH]', 'Project name' ) do | project |
    options[ :project ] = project
  end

  opts.on( '--users=[USER1,...]', 'Comma-separated list of users' ) do | users |
    options[ :users ] = users.split( ',' ).map( &:strip ).uniq
  end

end

opts.parse!

`groupadd #{ options[ :project ] }`
options[ :users ].each do | user |
  `usermod --append --groups #{ options[ :project ] } #{ user }`
end

project_path = "#{ options[ :repositories_path ] }/#{ options[ :project ] }"
FileUtils.mkdir_p project_path
FileUtils.cd project_path
`git --bare init`
FileUtils.chown_R 'git', options[ :project ], project_path
`chmod -R ug+w '#{ project_path }'`
File.open( 'config', 'w' ) do | file |
  file.write "\tsharedrepository = 1"
end

puts "Git repository '#{ options[ :project ] }' set up at '#{ project_path }' for users: #{ options[ :users ].join( ', ' ) }"
